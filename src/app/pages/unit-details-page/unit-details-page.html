<app-header></app-header>

<main class="unit-details-page">
  <div class="shell">

    @if (isLoading) {
      <section class="state" aria-label="Loading">
        <div class="state__card">
          <span class="spinner" aria-hidden="true"></span>
          <span>Loading osteological unit details.</span>
        </div>
      </section>
    }

    @if (!isLoading && errorMessage) {
      <section class="state" aria-label="Error">
        <div class="state__card state__card--error">
          <span class="ms" aria-hidden="true">error</span>
          <span>{{ errorMessage }}</span>
        </div>
      </section>
    }

    @if (!isLoading && unit) {

      <nav class="crumbs" aria-label="Breadcrumb">
        <a class="crumbs__link" routerLink="/">Home</a>
        <span class="ms crumbs__sep" aria-hidden="true">chevron_right</span>
        <a class="crumbs__link" routerLink="/sites">Sites</a>
        <span class="ms crumbs__sep" aria-hidden="true">chevron_right</span>
        <a class="crumbs__link" href="#" (click)="$event.preventDefault(); goToSite()">
          {{ unit.site.siteName || 'Site' }}
        </a>
        <span class="ms crumbs__sep" aria-hidden="true">chevron_right</span>
        <span class="crumbs__current">{{ primaryIndividualName }}</span>
      </nav>

      <!-- HEADER CARD: who/what/where -->
      <section class="unit-head" aria-label="Unit header">
        <div class="card card--hero">
          <div class="hero-row">
            <div class="hero-main">

              <h1 class="hero-title">{{ primaryIndividualName }}</h1>

              <div class="hero-sub">
                <span class="tag">{{ unitTypeLabel }}</span>
                <span class="sep">·</span>
                <a class="link" href="#" (click)="$event.preventDefault(); goToSite()">
                  {{ unit.site.siteName || '—' }}
                </a>
              </div>

              <div class="hero-sub hero-sub--muted">
                <span>{{ unit.upPhase || '—' }} Upper Palaeolithic</span>
                <span class="sep">/</span>
                <span>{{ unit.culturalAttribution || '—' }}</span>
              </div>
            </div>

            <div class="hero-actions">
              <div class="export-container">
                <button class="btn btn--outline" type="button" (click)="showExportMenu = !showExportMenu">
                  <span class="ms" aria-hidden="true">download</span>
                  Export
                  <span class="ms" aria-hidden="true">{{ showExportMenu ? 'expand_less' : 'expand_more' }}</span>
                </button>

                @if (showExportMenu) {
                  <div class="export-menu">
                    <button (click)="exportAs('csv')">
                      <span class="ms">table_view</span> CSV
                    </button>
                    <button (click)="exportAs('json')">
                      <span class="ms">code</span> JSON
                    </button>
                  </div>
                }
              </div>

              <button class="btn btn--soft" type="button" (click)="shareUnit()">
                <span class="ms" aria-hidden="true">share</span>
                Share
              </button>
            </div>
          </div>

          <!-- KPI GRID: fast scan -->
          <div class="kpi-grid" role="group" aria-label="Key metrics">
            <div class="kpi">
              <div class="kpi-k">Sex</div>
              <div class="kpi-v mono">{{ sexSummary || '—' }}</div>
            </div>

            <div class="kpi">
              <div class="kpi-k">Age at Death</div>
              <div class="kpi-v mono">{{ ageAtDeathSummary || '—' }}</div>
            </div>

            <div class="kpi">
              <div class="kpi-k">Age Class</div>
              <div class="kpi-v mono">{{ ageClassSummary }}</div>
            </div>

            <div class="kpi">
              <div class="kpi-k">Bones</div>
              <div class="kpi-v mono">{{ bonesCount }}</div>
            </div>

            <div class="kpi">
              <div class="kpi-k">Dating</div>
              <div class="kpi-v">
                <span class="badge" [class.badge--off]="!hasDating">{{ hasDating ? 'Present' : 'Absent' }}</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 3 CARDS: unit/specimen/individual in one glance -->
      <section class="tri" aria-label="Unit summary blocks">
        <div class="tri-grid">

          <article class="card">
            <h2 class="card-title">
              <span class="ms" aria-hidden="true">assignment</span>
              Unit data
            </h2>

            <dl class="kv">
              <div class="kv-row kv-row--wide">
                <dt>Stratigraphy</dt>
                <dd>{{ unit.stratigraphicContext || '—' }}</dd>
              </div>

              <div class="kv-row">
                <dt>Discovery year</dt>
                <dd class="mono">{{ unit.yearDiscovery || '—' }}</dd>
              </div>

              <div class="kv-row kv-row--wide">
                <dt>References</dt>
                <dd>{{ unit.contextRemainsReferences || '—' }}</dd>
              </div>

              <div class="kv-row kv-row--wide">
                <dt>Repository</dt>
                <dd>{{ repositorySummary }}</dd>
              </div>
            </dl>
          </article>

          <article class="card">
            <h2 class="card-title">
              <span class="ms" aria-hidden="true">science</span>
              Dating
            </h2>

            <dl class="kv">
              <div class="kv-row">
                <dt>BP (uncal)</dt>
                <dd class="mono">{{ bpUncalSummary }}</dd>
              </div>

              <div class="kv-row kv-row--wide">
                <dt>Range</dt>
                <dd>{{ dateRangeSummary }}</dd>
              </div>

              <div class="kv-row kv-row--wide">
                <dt>Technique</dt>
                <dd>{{ datingTechniqueSummary }}</dd>
              </div>

              <div class="kv-row kv-row--wide">
                <dt>Material</dt>
                <dd>{{ datingMaterialSummary }}</dd>
              </div>
            </dl>
          </article>

          <article class="card">
            <h2 class="card-title">
              <span class="ms" aria-hidden="true">person</span>
              Context
            </h2>

            <dl class="kv">
              <div class="kv-row">
                <dt>Age class</dt>
                <dd>{{ ageClassSummary }}</dd>
              </div>

              <div class="kv-row kv-row--wide">
                <dt>Burial context</dt>
                <dd>{{ unit.burialContext || '—' }}</dd>
              </div>

              <div class="kv-row">
                <dt>Ochre</dt>
                <dd>{{ unit.tracesOfOchre || '—' }}</dd>
              </div>

              <div class="kv-row kv-row--wide">
                <dt>Bone processing</dt>
                <dd>{{ unit.boneProcessing || '—' }}</dd>
              </div>
            </dl>
          </article>

        </div>
      </section>

      <!-- MAIN TABLE -->
      <section class="table-panel" aria-label="Bones inventory">
        <div class="table-panel__head">
          <h2>
            <span class="ms" aria-hidden="true">table_view</span>
            Associated bones
          </h2>
          <div class="count">{{ bonesCount }}</div>
        </div>

        <div class="table-wrap" role="region" aria-label="Bones inventory table">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">Bone</th>
                <th scope="col" class="num">Quantity</th>
                <th scope="col">Specimen</th>
                <th scope="col">Laterality</th>
                <th scope="col">Details</th>
              </tr>
            </thead>

            <tbody>
              @if (bonesCount === 0) {
                <tr>
                  <td colspan="5" class="td-empty">No bones available through linked specimens.</td>
                </tr>
              } @else {
                @for (r of boneRows; track r.bone.boneId) {
                  <tr class="tr">
                    <td class="strong">{{ r.bone.boneName || '—' }}</td>
                    <td class="num mono">{{ r.bone.boneQuantity || '—' }}</td>
                    <td class="strong">{{ r.specimen.specimenName }}</td>
                    <td class="muted">{{ r.bone.laterality || '—' }}</td>
                    <td class="muted">{{ r.bone.boneDetails || '—' }}</td>
                  </tr>
                }
              }
            </tbody>
          </table>
        </div>
      </section>

      <!-- IMAGES + BIB -->
      <section class="tail" aria-label="Images and bibliography">
        <div class="tail-grid">
          <article class="tail-panel">
            <div class="tail-head">
              <h3><span class="ms" aria-hidden="true">photo_library</span>Images</h3>
            </div>

            <p class="tail-text">
              Not implemented yet. This area will host photographs, drawings, and related media with captions, licensing, and source metadata.
            </p>

            <div class="placeholder">
              <div class="placeholder__title">No images available</div>
              <div class="placeholder__text">Suggested: zoom, attribution, and source references per file.</div>
            </div>
          </article>

          <article class="tail-panel tail-panel--ink">
            <div class="tail-head tail-head--ink">
              <h3><span class="ms" aria-hidden="true">menu_book</span>Bibliography</h3>
            </div>

            <p class="tail-text tail-text--ink">
              Currently shown from free-text fields. Later: structured references (DOI, BibTeX, tags).
            </p>

            <div class="bib">
              <div class="bib-item">
                <div class="bib-k">Context references</div>
                <div class="bib-v">{{ unit.contextRemainsReferences || '—' }}</div>
              </div>

              <div class="bib-item">
                <div class="bib-k">Chronocultural references</div>
                <div class="bib-v">{{ unit.chronoculturalReferences || '—' }}</div>
              </div>
            </div>
          </article>
        </div>
      </section>

    }
  </div>
</main>

<app-footer></app-footer>
